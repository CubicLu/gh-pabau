# Bitbucket Pipeline definition
image: node:14-buster

options:
  max-time: 60 # max time in minutes for each step

definitions:
  caches:
    nodemodules: node_modules/
    yarncustom: /usr/local/share/.cache/yarn
    cypress: '/root/.cache/Cypress'
  services:
    docker:
      memory: 3210

pipelines:
  pull-requests:
    '**':
      - step:
          name: yarn audit
          caches:
            - node
          script:
            - /bin/bash -c 'yarn audit --no-progress --non-interactive; [[ $? -lt 8 ]] && exit 0 || exit 1'
            - CYPRESS_CACHE_FOLDER=./dist/cypress CYPRESS_SKIP_BINARY_INSTALL=1 yarn install --frozen-lockfile --prefer-offline
          artifacts:
            - node_modules/**
            - libs/graphql/generated/**

      - parallel:
          - step:
              name: misc checks
              runs-on:
                - 'self.hosted'
              size: 2x
              script:
                - openssl version || true
                - ls -al || true
                - yarn bin || true
                - yarn bin || true
                - yarn lint:tsc --with-deps --base=origin/master
                - yarn lint:ls || true
                - yarn lint:workspace || true
                - npm i -g @graphql-inspector/cli@2.5.0 graphql || true
                - graphql-inspector validate "{libs,apps}/**/*.{graphql,tsx}" hasura/schema.graphql || echo TODO
                - graphql-inspector coverage "{libs,apps}/**/*.{graphql,tsx}" hasura/schema.graphql
                #                - graphql-inspector similar hasura/schema.graphql || echo TODO
                - graphql-inspector diff 'git:origin/master:./hasura/schema.graphql' 'hasura/schema.graphql' || echo TODO
                - DANGER_BITBUCKETCLOUD_OAUTH_KEY="${BITBUCKET_CLIENT_ID}" DANGER_BITBUCKETCLOUD_OAUTH_SECRET="${BITBUCKET_CLIENT_SECRET}" yarn danger ci --no-publish-check
                - node_modules/.bin/ts-node tools/cli/check-duplicate-filenames.ts

          - step:
              name: lint
              runs-on:
                - 'self.hosted'
              size: 2x
              script:
                - yarn affected:lint --base=origin/master --with-deps

          - step:
              name: unit tests
              runs-on:
                - 'self.hosted'
              size: 2x
              script:
                - yarn affected:test --base=origin/master

          - step:
              name: build
              runs-on:
                - 'self.hosted'
              max-time: 80
              size: 2x
              script:
                - NEXT_PUBLIC_GRAPHQL_ENDPOINT='https://api-v2-staging.pabau.com/v1/graphql' NEXT_PUBLIC_WS_ENDPOINT='wss://api-v2-staging.pabau.com/v1/graphql' yarn affected:export --base=origin/master --prod
              artifacts:
                - dist/**

          - step:
              name: e2e
              size: 2x
              caches:
                - cypress
              script:
                - apt update -y && apt install -y libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb
                - yarn cypress install || true
                - yarn affected:e2e --base=origin/master || true

      - parallel:
          - step:
              name: deploy dockers
              runs-on:
                - 'self.hosted'
              size: 2x
              services:
                - docker
              script:
                - apt-get update -y && apt-get install -y curl jq time
                - yarn affected --base=origin/master --target=deploy-docker
                - mkdir -p dist && cp -f /tmp/bot_message.txt dist/ || true
              artifacts:
                - dist/bot_message.txt

          - step:
              name: deploy previews
              image: node
              max-time: 20
              script:
                - node -v
                - ls -al . || true
                - ls -al node_modules/ || true
                - ls -al dist || true
                - ls -al dist/apps || true
                - cat /tmp/bot_message.txt || true
                - apt-get update -y && apt-get install -y curl jq time

                # get the commit message for this merge
                - export LAST_COMMIT_LOG=$(git log HEAD -1 | tail -n +4 | perl -p -e 's/[\r\n]//' | awk '{$1=$1;print}')
                - echo "${LAST_COMMIT_LOG}"
                - if [ "${LAST_COMMIT_LOG}" == "[skip ci] bumping version (patch)" ]; then (echo yes && export LAST_COMMIT_LOG=$(git log HEAD~1 -1 | tail -n +4)); fi
                - echo "${LAST_COMMIT_LOG}"

                - NODE_OPTIONS=--max_old_space_size=2750 /usr/bin/time -v yarn affected --base=origin/master --head=HEAD --target=deploy --prod
                - cat /tmp/bot_message.txt || true
                - cat /tmp/bot_message2.txt || true

                # Configure git to use the oauth token.
                - |
                  curl -sS -H "Authorization: Bearer ${access_token}" "https://api.bitbucket.org/2.0/repositories/${BITBUCKET_REPO_OWNER}/${BITBUCKET_REPO_SLUG}/pullrequests/${BITBUCKET_PR_ID}"
                  export PR_AUTHOR=$(curl -sS -H "Authorization: Bearer ${access_token}" "https://api.bitbucket.org/2.0/repositories/${BITBUCKET_REPO_OWNER}/${BITBUCKET_REPO_SLUG}/pullrequests/${BITBUCKET_PR_ID}" | jq -r '.author.display_name')
                  export COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')

                - |
                  printf ":shallow_pan_of_food::shallow_pan_of_food: *New PR Preview*\n## <https://bitbucket.org/pabau/monorepo/pull-requests/${BITBUCKET_PR_ID}|PR ${BITBUCKET_PR_ID}> committed by ${COMMIT_AUTHOR}\n${LAST_COMMIT_LOG}\n\n" > /tmp/bot_message2.txt
                  npm i -g ts-node@9 && ts-node tools/cicd/PrintChangedUrls.ts "origin/master" "$(cat /tmp/bot_url_web.txt || echo '')" "$(cat /tmp/bot_url_ui.txt || echo '')" >> /tmp/bot_message2.txt
                  printf "\n" >> /tmp/bot_message2.txt
                  cat /tmp/bot_message.txt >> /tmp/bot_message2.txt || true
                  printf "\n" >> /tmp/bot_message2.txt

                - cat /tmp/bot_message.txt || true
                - cat /tmp/bot_message2.txt || true
                - mkdir -p dist && cp -f /tmp/bot_message2.txt dist/ || true

              artifacts:
                - dist/bot_message2.txt
                - tools/cicd/slack_notification.json

          - step:
              name: announce to slack
              max-time: 15
              clone:
                enabled: false
              script:
                - cat dist/bot_message2.txt || true
                - cat dist/bot_message.txt || true
                - apt-get update -y && apt-get install -y curl jq

                # Post to Slack
                - |
                  jq --arg var "$(cat dist/bot_message2.txt | head -c 2900)$(cat dist/bot_message.txt | head -c 2900)" '.blocks[0].text.text = $var' tools/cicd/slack_notification.json | \
                    curl -0 "${SLACK_HOOK_URL}" \
                    -H "Expect:" \
                    -H 'Content-Type: application/json; charset=utf-8' \
                    --data-binary @-

                # Configure git to use the oauth token.
                - |
                  curl -sS -H "Authorization: Bearer ${access_token}" "https://api.bitbucket.org/2.0/repositories/${BITBUCKET_REPO_OWNER}/${BITBUCKET_REPO_SLUG}/pullrequests/${BITBUCKET_PR_ID}"
                  export PR_AUTHOR=$(curl -sS -H "Authorization: Bearer ${access_token}" "https://api.bitbucket.org/2.0/repositories/${BITBUCKET_REPO_OWNER}/${BITBUCKET_REPO_SLUG}/pullrequests/${BITBUCKET_PR_ID}" | jq -r '.author.display_name')
                  export COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')

                # Post to Bitbucket PR
                - |
                  curl https://api.bitbucket.org/2.0/repositories/pabau/monorepo/pullrequests/${BITBUCKET_PR_ID}/comments \
                    -H "Authorization: Bearer ${access_token}" \
                    --request POST \
                    --header 'Content-Type: application/json' \
                    --data '{
                      "content": {
                        "raw": "A new vercel was published!"
                      }
                    }'

  branches:
    master:
      - step:
          name: yarn audit
          caches:
            - node
          script:
            - /bin/bash -c 'yarn audit --no-progress --non-interactive; [[ $? -lt 8 ]] && exit 0 || exit 1'
            - CYPRESS_CACHE_FOLDER=./dist/cypress CYPRESS_SKIP_BINARY_INSTALL=1 yarn install --frozen-lockfile --prefer-offline
          artifacts:
            - node_modules/**
            - libs/graphql/generated/**

      - parallel:
          - step:
              name: misc checks
              runs-on:
                - 'self.hosted'
              size: 2x
              script:
                - openssl version || true
                - ls -al || true
                - ls -al node_modules || true
                - ls -al libs/graphql/generated/ || true
                - yarn postinstall || yarn --frozen-lockfile
                - ls -al node_modules || true
                - ls -al libs/graphql/generated/ || true
                - yarn bin || true
                - yarn bin || true
                - yarn lint:tsc --with-deps --base=HEAD~1
                - yarn lint:ls || true
                - yarn lint:workspace || true
                - npm i -g @graphql-inspector/cli@2.5.0 graphql || true
                - graphql-inspector validate "{libs,apps}/**/*.{graphql,tsx}" hasura/schema.graphql || echo TODO
                - graphql-inspector coverage "{libs,apps}/**/*.{graphql,tsx}" hasura/schema.graphql
                #                - graphql-inspector similar hasura/schema.graphql || echo TODO
                - graphql-inspector diff 'git:origin/master:./hasura/schema.graphql' 'hasura/schema.graphql' || echo TODO
                - node_modules/.bin/ts-node tools/cli/check-duplicate-filenames.ts

          - step:
              name: lint
              runs-on:
                - 'self.hosted'
              size: 2x
              script:
                - yarn affected:lint --base=HEAD~1 --with-deps

          - step:
              name: unit tests
              runs-on:
                - 'self.hosted'
              size: 2x
              script:
                - yarn affected:test --base=HEAD~1

          - step:
              name: e2e
              size: 2x
              caches:
                - cypress
              script:
                - apt update -y && apt install -y libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb
                - yarn cypress install || true
                - yarn affected:e2e --base=HEAD~1 || true

      - step:
          name: bump version
          max-time: 5
          script:
            # Get an oauth access token using the client credentials, parsing out the token with jq.
            - git remote set-url origin "${BITBUCKET_GIT_SSH_ORIGIN}"

            # bump the package.json version by 0.0.1
            - yarn version --message "[skip ci] bumping version (patch)" --patch --non-interactive --no-progress
            - HUSKY=0 git push && HUSKY=0 git push --tags
            - export PACKAGE_JSON_VERSION=$(jq -r .version < package.json)

      - step:
          name: build
          runs-on:
            - 'self.hosted'
          max-time: 80
          size: 2x
          script:
            - NEXT_PUBLIC_GRAPHQL_ENDPOINT='https://api-v2.pabau.com/v1/graphql' NEXT_PUBLIC_WS_ENDPOINT='wss://api-v2.pabau.com/v1/graphql' yarn affected:export --base=HEAD~1 --prod
          artifacts:
            - dist/**

      - parallel:
          - step:
              name: deploy dockers
              runs-on:
                - 'self.hosted'
              max-time: 20
              size: 2x
              deployment: production-dockers
              services:
                - docker
              script:
                - apt-get update -y && apt-get install -y curl jq time
                - yarn affected --base=HEAD~1 --target=deploy-docker --prod
                - mkdir -p dist && cp -f /tmp/bot_message.txt dist/ || true
              artifacts:
                - dist/bot_message.txt

          - step:
              name: deploy previews
              runs-on:
                - 'self.hosted'
              max-time: 20
              deployment: production-serverless
              script:
                - ls -al . || true
                - ls -al node_modules/ || true
                - ls -al dist || true
                - ls -al dist/apps || true
                - cat /tmp/bot_message.txt || true
                - apt-get update -y && apt-get install -y curl jq time

                # get the commit message for this merge
                - export LAST_COMMIT_LOG=$(git log HEAD -1 | tail -n +4 | perl -p -e 's/[\r\n]//' | awk '{$1=$1;print}')
                - echo "${LAST_COMMIT_LOG}"
                - if [ "${LAST_COMMIT_LOG}" == "[skip ci] bumping version (patch)" ]; then (echo yes && export LAST_COMMIT_LOG=$(git log HEAD~1 -1 | tail -n +4)); fi
                - echo "${LAST_COMMIT_LOG}"

                - NODE_OPTIONS=--max_old_space_size=2750 /usr/bin/time -v yarn affected --base=HEAD~1 --target=deploy --prod
                - export COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')

                - |
                  printf "*New Version Staged for Production*\n# v${PACKAGE_JSON_VERSION} committed by ${COMMIT_AUTHOR}\n${LAST_COMMIT_LOG}\n\n" > /tmp/bot_message2.txt
                  npm i -g ts-node@9 && ts-node tools/cicd/PrintChangedUrls.ts "HEAD~1" "$(cat /tmp/bot_url_web.txt || echo '')" "$(cat /tmp/bot_url_ui.txt || echo '')" >> /tmp/bot_message2.txt
                  printf "\n" >> /tmp/bot_message2.txt
                  cat /tmp/bot_message.txt >> /tmp/bot_message2.txt || true
                  printf "\n" >> /tmp/bot_message2.txt

                - cat /tmp/bot_message2.txt || true
                - mkdir -p dist && cp -f /tmp/bot_message2.txt dist/ || true

              artifacts:
                - dist/bot_message2.txt

      - step:
          name: announce to slack
          max-time: 15
          script:
            - cat dist/bot_message2.txt || true
            - cat dist/bot_message.txt || true
            - apt-get update -y && apt-get install -y curl jq time

            # Post to Slack
            - |
              jq --arg var "$(cat dist/bot_message2.txt | head -c 2900)$(cat dist/bot_message.txt | head -c 2900)" '.blocks[0].text.text = $var' tools/cicd/slack_notification.json | curl -0 "${SLACK_HOOK_URL}" \
              -H "Expect:" \
              -H 'Content-Type: application/json; charset=utf-8' \
              --data-binary @-
